---
import Layout from "../../layouts/Layout.astro";

const winnerName = "???";
const winnerNumber = "???";
---

<Layout title="Hlasovanie 4.B - Lot√©ria">
    <main class="presenter-container">
        <header class="presenter-header">
            <span class="presenter-title">Hlasovanie 4.B</span>
        </header>

        <div class="lottery-content">
            <div id="dividerTop" class="divider" style="display: none;"></div>
            <div
                id="winnerSection"
                class="winner-section"
                style="display: none;"
            >
                <span class="vote-count"
                    >Vyhral/a: <span class="vote-result" id="winnerName">{winnerName}</span></span
                >
                <span class="vote-count"
                    >ID: <span class="vote-result" id="winnerNumber">{winnerNumber}</span></span
                >
            </div>
            <div id="dividerBottom" class="divider" style="display: none;"></div>

            <button id="lotteryBtn" class="lottery-btn">Vy≈ærebova≈•</button>

            <div id="partyEmoji" class="party-emoji">üéâ</div>
        </div>
    </main>

    <script>
        import { api, ApiError } from "../../lib/api";

        function createConfetti() {
            const confettiPieces = 50;
            for (let i = 0; i < confettiPieces; i++) {
                const confetti = document.createElement("div");
                confetti.style.position = "fixed";
                confetti.style.width = "10px";
                confetti.style.height = "10px";
                confetti.style.borderRadius = "50%";
                confetti.style.pointerEvents = "none";
                confetti.style.left = Math.random() * 100 + "%";
                confetti.style.top = "-10px";
                const colors = ["#D4AF37", "#764ba2", "#f093fb", "#4facfe"];
                confetti.style.backgroundColor =
                    colors[Math.floor(Math.random() * colors.length)];
                document.body.appendChild(confetti);

                let top = -10;
                const speed = 2 + Math.random() * 3;
                const interval = setInterval(() => {
                    top += speed;
                    confetti.style.top = top + "px";
                    confetti.style.opacity = (
                        1 -
                        top / window.innerHeight
                    ).toString();

                    if (top > window.innerHeight) {
                        clearInterval(interval);
                        confetti.remove();
                    }
                }, 20);
            }
        }

        async function selectWinner() {
            const btn = document.getElementById(
                "lotteryBtn",
            ) as HTMLButtonElement;
            const winnerSection = document.getElementById("winnerSection");
            const dividerTop = document.getElementById("dividerTop");
            const dividerBottom = document.getElementById("dividerBottom");

            if (btn) btn.disabled = true;

            try {
                const winner = await api.admin.pickWinner();

                const nameEl = document.getElementById("winnerName");
                const numberEl = document.getElementById("winnerNumber");
                const partyEl = document.getElementById("partyEmoji");

                if (nameEl) nameEl.textContent = winner.name;
                if (numberEl) numberEl.textContent = winner.voter_id;

                // Hide button and show winner section and dividers
                if (btn) btn.style.display = "none";
                if (winnerSection) winnerSection.style.display = "flex";
                if (dividerTop) dividerTop.style.display = "block";
                if (dividerBottom) dividerBottom.style.display = "block";

                // Show party emoji
                if (partyEl) {
                    partyEl.style.display = "block";
                    setTimeout(() => {
                        partyEl.style.display = "none";
                    }, 2000);
                }

                // Create confetti
                createConfetti();
            } catch (error) {
                if (error instanceof ApiError && error.status === 404) {
                    alert("≈Ωiadni √∫ƒçastn√≠ci na ≈ærebovanie.");
                } else {
                    console.error(error);
                    alert("Nepodarilo sa vy≈ærebova≈• v√Ωhercu.");
                }
                if (btn) btn.disabled = false;
            }
        }

        function setupLotteryButton() {
            const btn = document.getElementById("lotteryBtn");
            if (btn) {
                btn.addEventListener("click", selectWinner);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", setupLotteryButton);
        } else {
            setupLotteryButton();
        }
    </script>
</Layout>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght@6..144,1..1000&display=swap');
    main {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        background-color: #ffffff;
    }

    .vote-result {
        color: #d4af37;
    }

    .presenter-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem;
        border-bottom: 1px solid #e5e5e5;
    }

    .presenter-title {
        font-family: "Google Sans Flex", sans-serif;
        font-size: 2.5rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .lottery-content {
        display: flex;
        flex-direction: column;
        flex: 1;
        justify-content: center;
        align-items: center;
        gap: 3rem;
    }

    .winner-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
    }

    .vote-count {
        font-family: "Google Sans Flex", sans-serif;
        font-size: 2.5rem;
        color: #1a1a1a;
        font-weight: 600;
    }

    .lottery-btn {
        font-family: "Google Sans Flex", sans-serif;
        font-size: 1.25rem;
        font-weight: 600;
        color: #ffffff;
        background-color: #d4af37;
        border: none;
        border-radius: 8px;
        padding: 1rem 3rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .lottery-btn:hover:not(:disabled) {
        background-color: #f5cb40;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(234, 221, 102, 0.3);
    }

    .lottery-btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .lottery-btn:disabled {
        background-color: #ccc;
        cursor: default;
        transform: none;
        box-shadow: none;
    }

    .party-emoji {
        font-size: 5rem;
        display: none;
        animation: bounce 0.6s ease;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .divider {
        width: 60px;
        height: 4px;
        background-color: #d4af37;
        border-radius: 2px;
    }

    @keyframes bounce {
        0% {
            transform: translate(-50%, -50%) scale(0);
        }
        50% {
            transform: translate(-50%, -50%) scale(1.2);
        }
        100% {
            transform: translate(-50%, -50%) scale(1);
        }
    }
</style>
