---
import Layout from "../../layouts/Layout.astro";

const joinLink = "lnk.sk/mozi5";
const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(joinLink)}`;
---

<Layout title="Hlasovanie 4.B - Prezentér">
    <main class="presenter-container">
        <header class="presenter-header">
            <span class="presenter-title">Hlasovanie 4.B</span>
        </header>

        <div class="presenter-content">
            <div class="left-section">
                <span class="section-label">Pripojte sa:</span>
                <span class="join-link">{joinLink}</span>
                <div class="qr-code-container">
                    <img src={qrCodeUrl} alt="QR Code" class="qr-code" />
                </div>
            </div>

            <div class="divider-vertical"></div>

            <div class="right-section">
                <!-- Login UI shown when not authenticated -->
                <div id="presenter-login" class="presenter-login">
                    <input
                        id="presenter-password"
                        type="password"
                        placeholder="Heslo prezentéra"
                        class="password-input"
                    />
                    <button id="presenter-login-btn" class="start-btn">
                        Prihlásiť
                    </button>
                </div>

                <!-- Controls shown only when authenticated -->
                <div
                    id="presenter-controls"
                    class="presenter-controls"
                    style="display: none;"
                >
                    <span class="vote-count"
                        >Počet hlasov: <span id="voter-count">0</span></span
                    >
                    <button id="start-btn" class="start-btn">
                        <span>Začať hlasovanie</span>
                    </button>
                    <a href="/presenter/chart" class="chart-link"
                        >Zobraziť výsledky</a
                    >
                    <button id="presenter-logout-btn" class="logout-btn"
                        >Odhlásiť</button
                    >
                </div>
            </div>
        </div>
    </main>

    <script>
        import { api } from "../../lib/api";

        // Presenter auth helper functions (uses backend endpoints)
        async function isAuthenticated(): Promise<boolean> {
            try {
                const res = await fetch("/api/presenter/check");
                if (!res.ok) return false;
                const ok = await res.json();
                return !!ok;
            } catch (e) {
                return false;
            }
        }

        async function presenterLogin(password: string): Promise<boolean> {
            try {
                const res = await fetch("/api/presenter/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password }),
                });
                return res.ok;
            } catch (e) {
                return false;
            }
        }

        async function presenterLogout(): Promise<void> {
            try {
                await fetch("/api/presenter/logout", { method: "POST" });
            } catch (e) {
                // ignore
            }
        }

        async function startVoting() {
            const btn = document.getElementById(
                "start-btn",
            ) as HTMLButtonElement;
            if (!btn) return;

            try {
                btn.disabled = true;
                btn.textContent = "Spúšťam...";

                await api.admin.setStatus("start");

                btn.textContent = "Hlasovanie spustené";
                btn.classList.add("active");
            } catch (error) {
                console.error("Error starting voting:", error);
                btn.disabled = false;
                btn.textContent = "Začať hlasovanie";
                alert("Chyba pri komunikácii so serverom.");
            }
        }

        async function updateStats() {
            try {
                const count = await api.admin.getStats();
                const el = document.getElementById("voter-count");
                if (el) el.textContent = count.toString();
            } catch (e) {
                console.error("Error fetching stats", e);
            }
        }

        async function checkStatus() {
            const btn = document.getElementById(
                "start-btn",
            ) as HTMLButtonElement;
            if (!btn) return;

            try {
                const isReady = await api.admin.getStatus();
                if (isReady) {
                    btn.textContent = "Hlasovanie spustené";
                    btn.classList.add("active");
                    btn.disabled = true;
                } else {
                    btn.textContent = "Začať hlasovanie";
                    btn.classList.remove("active");
                    btn.disabled = false;
                }
            } catch (e) {
                console.error("Error checking status", e);
            }
        }

        let pollInterval: number | null = null;

        function startPolling() {
            if (pollInterval) return;
            checkStatus();
            updateStats();
            pollInterval = setInterval(updateStats, 2000) as unknown as number;
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Handle presenter UI visibility and auth
        async function initPresenterAuth() {
            const loginContainer = document.getElementById("presenter-login")!;
            const controlsContainer =
                document.getElementById("presenter-controls")!;
            const loginBtn = document.getElementById(
                "presenter-login-btn",
            ) as HTMLButtonElement | null;
            const logoutBtn = document.getElementById(
                "presenter-logout-btn",
            ) as HTMLButtonElement | null;
            const passwordInput = document.getElementById(
                "presenter-password",
            ) as HTMLInputElement | null;

            const updateUi = (authed: boolean) => {
                if (authed) {
                    loginContainer.style.display = "none";
                    controlsContainer.style.display = "flex";
                    startPolling();
                } else {
                    loginContainer.style.display = "flex";
                    controlsContainer.style.display = "none";
                    stopPolling();
                }
            };

            const authed = await isAuthenticated();
            updateUi(authed);

            if (loginBtn && passwordInput) {
                loginBtn.addEventListener("click", async () => {
                    loginBtn.disabled = true;
                    const ok = await presenterLogin(passwordInput.value);
                    loginBtn.disabled = false;
                    if (ok) {
                        updateUi(true);
                        attachControls();
                    } else {
                        alert("Nesprávne heslo");
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener("click", async () => {
                    await presenterLogout();
                    updateUi(false);
                });
            }

            if (authed) {
                attachControls();
            }
        }

        // Attach control events (only call after authenticated)
        function attachControls() {
            const btn = document.getElementById("start-btn");
            if (btn) {
                btn.removeEventListener("click", startVoting);
                btn.addEventListener("click", startVoting);
            }
        }

        // Initialize
        initPresenterAuth();
    </script>

    <style>
        main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            background-color: #ffffff;
        }

        .presenter-header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            border-bottom: 1px solid #e5e5e5;
        }

        .presenter-title {
            font-family: "Inter", sans-serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        .presenter-content {
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: space-between;
            padding: 0 4rem;
            gap: 2rem;
        }

        .left-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
        }

        .section-label {
            font-family: "Inter", sans-serif;
            font-size: 1rem;
            color: #666666;
            font-weight: 500;
        }

        .join-link {
            font-family: "Inter", sans-serif;
            font-size: 2rem;
            color: #d4af37;
            font-weight: 600;
        }

        .qr-code-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-top: 1rem;
            width: fit-content;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            border-radius: 8px;
        }

        .divider-vertical {
            width: 4px;
            height: 200px;
            background-color: #d4af37;
            border-radius: 2px;
        }

        .right-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            flex: 1;
            align-items: center;
            justify-content: center;
        }

        .vote-count {
            font-family: "Inter", sans-serif;
            font-size: 1.5rem;
            color: #1a1a1a;
            font-weight: 600;
        }

        .start-btn {
            font-family: "Inter", sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff;
            background-color: #d4af37;
            border: none;
            border-radius: 8px;
            padding: 1rem 3rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .start-btn:hover:not(:disabled) {
            background-color: #f5cb40;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 221, 102, 0.3);
        }

        .start-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .start-btn:disabled {
            background-color: #ccc;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        .start-btn.active {
            background-color: #4caf50;
            color: white;
        }

        .chart-link {
            font-family: "Inter", sans-serif;
            color: #666;
            text-decoration: underline;
            cursor: pointer;
        }

        .presenter-login {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            width: 100%;
            max-width: 300px;
        }

        .presenter-controls {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
            width: 100%;
        }

        .password-input {
            width: 100%;
            padding: 1rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-family: "Inter", sans-serif;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .password-input:focus {
            border-color: #d4af37;
        }

        .logout-btn {
            font-family: "Inter", sans-serif;
            font-size: 1rem;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            padding: 0.5rem;
        }

        .logout-btn:hover {
            color: #1a1a1a;
        }
    </style>
</Layout>
