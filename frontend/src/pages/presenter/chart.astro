---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Hlasovanie 4.B - Grafika">
    <main class="chart-container">
        <header class="chart-header">
            <span class="chart-title">Hlasovanie 4.B</span>
            <div class="chart-right">
                <div class="stats">
                <span class="chart-stats">Nezahlasované: <span id="unvoted" class="stat-value">0</span></span>
                <span class="chart-stats">|</span>
                <span class="chart-stats">Zahlasované: <span id="voted" class="stat-value">0</span></span>
                </div>
                <!-- Login UI shown when not authenticated -->
                <div id="presenter-login" class="presenter-login">
                    <input
                        id="presenter-password"
                        type="password"
                        placeholder="Heslo prezentéra"
                        class="password-input"
                    />
                    <button id="presenter-login-btn" class="evaluate-btn">
                        Prihlásiť
                    </button>
                </div>

                <!-- Controls shown only when authenticated -->
                <div
                    id="presenter-controls"
                    class="presenter-controls"
                    style="display: none;"
                >
                    <button id="evaluate-btn" class="evaluate-btn"
                        >Vyhodnotiť</button
                    >
                    <button id="presenter-logout-btn" class="logout-btn"
                        >Odhlásiť</button
                    >
                </div>
            </div>
        </header>
        <div class="chart-wrapper">
            <canvas id="voteChart"></canvas>
        </div>
    </main>

    <script>
        import Chart from "chart.js/auto";
        import { api } from "../../lib/api";

        let chartInstance: Chart | null = null;
        let isEvaluated = false;

        // Initial empty data
        const chartData = {
            labels: [],
            datasets: [
                {
                    label: "Počet hlasov",
                    data: [],
                    backgroundColor: "#D4AF37",
                    borderColor: "#D4AF37",
                    borderWidth: 1,
                    borderRadius: 6,
                },
            ],
        };

        // Plugin to display values on bars
        const dataLabelsPlugin = {
            id: "dataLabels",
            afterDatasetsDraw(chart: Chart) {
                if (isEvaluated) return;

                chart.data.datasets.forEach((dataset, datasetIndex) => {
                    const meta = chart.getDatasetMeta(datasetIndex);
                    if (!meta.hidden) {
                        meta.data.forEach((element, index) => {
                            const ctx = chart.ctx;
                            const value = dataset.data[index];

                            // @ts-ignore
                            const { x, y } = element;

                            ctx.fillStyle = "#1a1a1a";
                            ctx.font = 'bold 14px "Inter", sans-serif';
                            ctx.textAlign = "center";
                            ctx.textBaseline = "bottom";

                            const padding = 5;
                            ctx.fillText(value as string, x, y - padding);
                        });
                    }
                });
            },
        };

        // Initialize Chart.js
        function initChart() {
            const ctx = document.getElementById(
                "voteChart",
            ) as HTMLCanvasElement;
            if (ctx) {
                chartInstance = new Chart(ctx, {
                    type: "bar",
                    data: chartData,
                    plugins: [dataLabelsPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    font: {
                                        family: "'Inter', sans-serif",
                                        size: 14,
                                        weight: "600",
                                    },
                                    color: "#1a1a1a",
                                    padding: 20,
                                },
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    font: {
                                        family: "'Inter', sans-serif",
                                        size: 12,
                                    },
                                    color: "#666666",
                                    stepSize: 1,
                                },
                                grid: {
                                    color: "rgba(0, 0, 0, 0.05)",
                                    drawBorder: false,
                                },
                            },
                            x: {
                                ticks: {
                                    font: {
                                        family: "'Inter', sans-serif",
                                        size: 12,
                                    },
                                    color: "#666666",
                                },
                                grid: {
                                    display: false,
                                    drawBorder: false,
                                },
                            },
                        },
                    },
                });
            }
        }

        async function fetchData() {
            try {
                const results = await api.admin.getResults();

                if (chartInstance) {
                    const labels = results.map((r) => r.name);
                    const data = results.map((r) => r.votes);
                    const totalVotes = data.reduce(
                        (a: number, b: number) => a + b,
                        0,
                    );

                    chartInstance.data.labels = labels;
                    chartInstance.data.datasets[0].data = data;
                    chartInstance.update();

                    const totalEl = document.getElementById("voted");
                    if (totalEl) totalEl.textContent = totalVotes.toString();
                }
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Presenter auth helper functions (uses backend endpoints)
        async function isAuthenticated(): Promise<boolean> {
            try {
                const res = await fetch("/api/presenter/check");
                if (!res.ok) return false;
                const ok = await res.json();
                return !!ok;
            } catch (e) {
                return false;
            }
        }

        async function presenterLogin(password: string): Promise<boolean> {
            try {
                const res = await fetch("/api/presenter/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password }),
                });
                return res.ok;
            } catch (e) {
                return false;
            }
        }

        async function presenterLogout(): Promise<void> {
            try {
                await fetch("/api/presenter/logout", { method: "POST" });
            } catch (e) {
                // ignore
            }
        }

        let pollInterval: number | null = null;

        function startPolling() {
            if (pollInterval) return;
            fetchData();
            pollInterval = setInterval(() => {
                if (!isEvaluated) fetchData();
                else stopPolling();
            }, 2000) as unknown as number;
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Handle evaluate button click
        async function evaluateVotes() {
            const btn = document.getElementById("evaluate-btn");
            if (!btn) return;

            // First click: Stop voting and show final results (if not already stopped)
            // For now, we just stop polling and prepare for lottery
            isEvaluated = true;

            // Stop voting on server
            try {
                await api.admin.setStatus("stop");
            } catch (e) {
                console.error("Failed to stop voting", e);
            }

            // Update chart to show equal numbers (fun reveal)
            if (chartInstance) {
                const count = chartInstance.data.labels?.length || 0;
                // Set all to 100% or just a high number
                const equalData = new Array(count).fill(100);

                chartInstance.data.datasets[0].data = equalData;

                // Hide Y axis to make it look cleaner
                if (chartInstance.options.scales?.y) {
                    chartInstance.options.scales.y.display = false;
                }

                chartInstance.update();
            }

            // Change button to "Lottery"
            btn.textContent = "Prejsť na lotériu";
            btn.removeEventListener("click", evaluateVotes);
            btn.addEventListener("click", redirectToLottery);
        }

        function redirectToLottery() {
            window.location.href = "/presenter/lottery";
        }

        // Attach control events (only call after authenticated)
        function attachControls() {
            const btn = document.getElementById("evaluate-btn");
            if (btn) {
                btn.removeEventListener("click", evaluateVotes);
                btn.addEventListener("click", evaluateVotes);
            }
            const logoutBtn = document.getElementById("presenter-logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", async () => {
                    await presenterLogout();
                    updateUi(false);
                });
            }
        }

        function updateUi(authed: boolean) {
            const loginContainer = document.getElementById("presenter-login")!;
            const controlsContainer =
                document.getElementById("presenter-controls")!;
            if (authed) {
                loginContainer.style.display = "none";
                controlsContainer.style.display = "flex";
                startPolling();
            } else {
                loginContainer.style.display = "flex";
                controlsContainer.style.display = "none";
                stopPolling();
            }
        }

        async function initPresenterAuth() {
            const loginBtn = document.getElementById(
                "presenter-login-btn",
            ) as HTMLButtonElement | null;
            const passwordInput = document.getElementById(
                "presenter-password",
            ) as HTMLInputElement | null;

            const authed = await isAuthenticated();
            updateUi(authed);
            if (authed) attachControls();

            if (loginBtn && passwordInput) {
                loginBtn.addEventListener("click", async () => {
                    loginBtn.disabled = true;
                    const ok = await presenterLogin(passwordInput.value);
                    loginBtn.disabled = false;
                    if (ok) {
                        updateUi(true);
                        attachControls();
                    } else {
                        alert("Nesprávne heslo");
                    }
                });
            }
        }

        // Initialize chart when DOM is ready
        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", async () => {
                initChart();
                await initPresenterAuth();
            });
        } else {
            initChart();
            initPresenterAuth();
        }
    </script>
</Layout>

<style>
    main {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100%;
        background-color: #ffffff;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 2rem 4rem;
        border-bottom: 1px solid #e5e5e5;
    }

    .chart-title {
        font-family: "Inter", sans-serif;
        font-size: 2.5rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .chart-right {
        display: flex;
        align-items: center;
        gap: 2rem;
    }

    .chart-stats {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        color: #666666;
        flex: 1;
        text-align: center;
    }

    .stat-value {
        font-weight: 600;
        color: #1a1a1a;
    }

    .evaluate-btn {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #ffffff;
        background-color: #d4af37;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .evaluate-btn:hover {
        background-color: #f5cb40;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(234, 221, 102, 0.3);
    }

    .evaluate-btn:active {
        transform: translateY(0);
    }

    .chart-wrapper {
        flex: 1;
        padding: 2rem 4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 500px;
        width: 100%;
    }

    canvas {
        max-width: 100%;
        height: 100%;
    }

    .presenter-login {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-left: 1rem;
    }

    .presenter-controls {
        display: flex;
        gap: 0.5rem;
        margin-left: 1rem;
    }

    .password-input {
        padding: 0.4rem;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-family: "Inter", sans-serif;
        font-size: 1rem;
    }

    .logout-btn {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #666;
        background: none;
        border: none;
        cursor: pointer;
        text-decoration: underline;
        padding: 0.75rem 1rem;
    }

    .logout-btn:hover {
        color: #1a1a1a;
    }
</style>
