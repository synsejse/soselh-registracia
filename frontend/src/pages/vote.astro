---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Hlasovanie 4.B">
    <main class="voting-container">
        <span class="voting-title">Hlasovanie 4.B</span>
        <div class="divider"></div>
        <span class="main-text">Ktoré vystúpenie sa Vám najviac páčilo?</span>

        <div id="options-container" class="options-container">
            <!-- Candidates will be loaded here -->
            <p class="loading-text">Načítavam kandidátov...</p>
        </div>

        <button id="submit-vote-btn" class="submit-btn" disabled
            >Hlasovať</button
        >
        <div class="divider"></div>
        <span class="voting-footer">Tobias Slabej & Kristián Kekeš @ 2025</span>
    </main>

    <script>
        import { api, ApiError } from "../lib/api";

        const optionsContainer = document.getElementById("options-container");
        const submitBtn = document.getElementById(
            "submit-vote-btn",
        ) as HTMLButtonElement;
        let selectedCandidateId: number | null = null;

        async function loadCandidates() {
            try {
                const candidates = await api.getCandidates();

                if (optionsContainer) {
                    optionsContainer.innerHTML = ""; // Clear loading text

                    candidates.forEach((candidate) => {
                        const label = document.createElement("label");
                        label.className = "radio-option";

                        const input = document.createElement("input");
                        input.type = "radio";
                        input.name = "performance";
                        input.value = candidate.id.toString();

                        input.addEventListener("change", (e) => {
                            selectedCandidateId = parseInt(
                                (e.target as HTMLInputElement).value,
                            );
                            if (submitBtn) {
                                submitBtn.disabled = false;
                            }
                        });

                        const span = document.createElement("span");
                        span.textContent = candidate.name;

                        label.appendChild(input);
                        label.appendChild(span);
                        optionsContainer.appendChild(label);
                    });
                }
            } catch (error) {
                console.error("Error loading candidates:", error);
                if (optionsContainer) {
                    optionsContainer.innerHTML =
                        '<p class="error-text">Nepodarilo sa načítať kandidátov.</p>';
                }
            }
        }

        async function submitVote() {
            if (!selectedCandidateId) return;

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = "Odosielam...";

                await api.castVote(selectedCandidateId);
                window.location.href = "/vote-complete";
            } catch (error) {
                console.error("Error submitting vote:", error);

                if (error instanceof ApiError) {
                    if (error.status === 409) {
                        alert("Už ste hlasovali.");
                        window.location.href = "/vote-complete";
                        return;
                    } else if (error.status === 412) {
                        alert("Hlasovanie nie je aktívne.");
                        window.location.href = "/";
                        return;
                    }
                }

                alert("Nastala chyba pri hlasovaní. Skúste to prosím znova.");
                submitBtn.disabled = false;
                submitBtn.textContent = "Hlasovať";
            }
        }

        // Check if user already voted or if voting is disabled
        async function checkVoteStatus() {
            try {
                const status = await api.getStatus();

                if (!status.ready) {
                    window.location.href = "/";
                    return;
                }

                if (status.has_voted) {
                    window.location.href = "/vote-complete";
                }
            } catch (e) {
                console.error("Failed to check vote status", e);
            }
        }

        if (submitBtn) {
            submitBtn.addEventListener("click", submitVote);
        }

        // Initialize
        checkVoteStatus();
        loadCandidates();
    </script>
</Layout>

<style>
    main {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
        width: 100%;
        gap: 1.5rem;
    }

    .voting-footer {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        color: #666666;
    }

    .main-text {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        color: #111111;
    }

    .loading-text,
    .error-text {
        font-family: "Inter", sans-serif;
        color: #666;
    }

    .error-text {
        color: #d32f2f;
    }

    .voting-title {
        font-family: "Inter", sans-serif;
        font-size: 40px;
        font-weight: 200;
        text-align: center;
        color: #1a1a1a;
    }

    .divider {
        width: 60px;
        height: 4px;
        background-color: #d4af37;
        border-radius: 2px;
    }

    .options-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 100px; /* Prevent layout shift */
        justify-content: center;
    }

    /* Use global to target dynamically created elements if needed,
     but since we are in Astro scoped styles, we might need :global()
     or just rely on the fact that they are children of .options-container */
    :global(.radio-option) {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        color: #1a1a1a;
        cursor: pointer;
        user-select: none;
    }

    :global(.radio-option input[type="radio"]) {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #d4af37;
    }

    .submit-btn {
        font-family: "Inter", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #ffffff;
        background-color: #d4af37;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 2.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .submit-btn:hover:not(:disabled) {
        background-color: #f5cb40;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(234, 221, 102, 0.3);
    }

    .submit-btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .submit-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
</style>
