---
import Layout from "../layouts/Layout.astro";
import Phone from "../icons/Phone.astro";
import Envelope from "../icons/Envelope.astro";
import Calendar from "../icons/Calendar.astro";
import Clock from "../icons/Clock.astro";
import Logo from "../icons/Logo.astro";
---

<Layout title="Prihlasovanie na odborové dni">
    <main
        class="min-h-screen w-full bg-gradient-to-br from-gray-100 to-gray-300 py-12 px-4 sm:px-6 lg:px-8 flex justify-center items-start"
    >
        <div class="max-w-5xl w-full">
            <div class="flex justify-center mb-8">
                <Logo
                    class="h-24 w-auto"
                    aria-label="Logo SOŠ Elektrotechnická"
                />
            </div>
            <h1
                class="text-4xl md:text-5xl font-extrabold text-center text-gray-900 mb-10 drop-shadow-sm"
            >
                Prihlasovanie na odborové dni
            </h1>

            <div
                id="status-message"
                class="hidden p-5 rounded-xl mb-8 text-center font-bold shadow-sm"
            >
            </div>

            <div id="registration-form-container">
                <form
                    id="registration-form"
                    class="bg-white rounded-3xl shadow-2xl p-6 md:p-12 border border-gray-100"
                >
                    <div class="mb-10">
                        <h2
                            class="inline-block text-2xl font-bold text-gray-900 mb-6 pb-2 border-b-4 border-yellow-500"
                        >
                            Údaje o žiakovi
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label
                                    for="student_first_name"
                                    class="block font-semibold text-gray-800 mb-2 text-sm md:text-base"
                                    >Meno žiaka *</label
                                >
                                <input
                                    type="text"
                                    id="student_first_name"
                                    name="student_first_name"
                                    required
                                    placeholder="Jožko"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-yellow-500 focus:bg-white focus:ring-4 focus:ring-yellow-500/10 hover:border-gray-300"
                                />
                            </div>
                            <div>
                                <label
                                    for="student_last_name"
                                    class="block font-semibold text-gray-800 mb-2 text-sm md:text-base"
                                    >Priezvisko žiaka *</label
                                >
                                <input
                                    type="text"
                                    id="student_last_name"
                                    name="student_last_name"
                                    required
                                    placeholder="Mrkvička"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-yellow-500 focus:bg-white focus:ring-4 focus:ring-yellow-500/10 hover:border-gray-300"
                                />
                            </div>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h2
                            class="inline-block text-2xl font-bold text-gray-900 mb-6 pb-2 border-b-4 border-yellow-500"
                        >
                            Údaje o zákonnom zástupcovi
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label
                                    for="guardian_first_name"
                                    class="block font-semibold text-gray-800 mb-2 text-sm md:text-base"
                                    >Meno zákonného zástupcu *</label
                                >
                                <input
                                    type="text"
                                    id="guardian_first_name"
                                    name="guardian_first_name"
                                    required
                                    placeholder="Jozef"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-yellow-500 focus:bg-white focus:ring-4 focus:ring-yellow-500/10 hover:border-gray-300"
                                />
                            </div>
                            <div>
                                <label
                                    for="guardian_last_name"
                                    class="block font-semibold text-gray-800 mb-2 text-sm md:text-base"
                                    >Priezvisko zákonného zástupcu *</label
                                >
                                <input
                                    type="text"
                                    id="guardian_last_name"
                                    name="guardian_last_name"
                                    required
                                    placeholder="Mrkvička"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-yellow-500 focus:bg-white focus:ring-4 focus:ring-yellow-500/10 hover:border-gray-300"
                                />
                            </div>
                            <div>
                                <label
                                    for="guardian_phone"
                                    class="block font-semibold text-gray-800 mb-2 text-sm md:text-base"
                                    >Telefón zákonného zástupcu *</label
                                >
                                <div class="relative">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                                    >
                                        <Phone class="h-5 w-5 text-gray-400" />
                                    </div>
                                    <input
                                        type="tel"
                                        id="guardian_phone"
                                        name="guardian_phone"
                                        required
                                        pattern="[+]?[0-9\\s]{10,15}"
                                        placeholder="+421 900 000 000"
                                        title="Zadajte platné telefónne číslo (napr. +421 900 000 000)"
                                        class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-yellow-500 focus:bg-white focus:ring-4 focus:ring-yellow-500/10 hover:border-gray-300"
                                    />
                                </div>
                                <p class="mt-1 text-xs text-gray-500 pl-1">
                                    Formát: +421 9XX XXX XXX alebo 09XX XXX XXX
                                </p>
                            </div>
                            <div>
                                <label
                                    for="guardian_email"
                                    class="block font-semibold text-gray-800 mb-2 text-sm md:text-base"
                                    >Email zákonného zástupcu *</label
                                >
                                <div class="relative">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                                    >
                                        <Envelope
                                            class="h-5 w-5 text-gray-400"
                                        />
                                    </div>
                                    <input
                                        type="email"
                                        id="guardian_email"
                                        name="guardian_email"
                                        required
                                        placeholder="priklad@email.com"
                                        class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg text-base transition-all duration-300 bg-gray-50 focus:outline-none focus:border-yellow-500 focus:bg-white focus:ring-4 focus:ring-yellow-500/10 hover:border-gray-300"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-10">
                        <h2
                            class="inline-block text-2xl font-bold text-gray-900 mb-6 pb-2 border-b-4 border-yellow-500"
                        >
                            Výber termínu a odboru
                        </h2>
                        <div id="sessions-container" class="mt-4">
                            <p class="text-center text-gray-500 p-4">
                                Načítavam dostupné termíny...
                            </p>
                        </div>
                    </div>

                    <button
                        type="submit"
                        id="submit-btn"
                        class="w-full py-4 bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-xl text-lg font-bold uppercase tracking-wider shadow-lg transition-all duration-300 hover:from-yellow-600 hover:to-yellow-700 hover:-translate-y-1 hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none"
                        disabled
                    >
                        Prihlásiť sa
                    </button>
                </form>
            </div>

            <div class="mt-12 text-center text-gray-500 font-medium text-sm">
                <span>Kristián Kekeš & SOŠ Elektrotechnická</span>
            </div>
        </div>

        <!-- Hidden icon templates for JavaScript to reference -->
        <template id="calendar-icon-template">
            <Calendar class="h-4 w-4" />
        </template>
        <template id="clock-icon-template">
            <Clock class="h-4 w-4" />
        </template>
    </main>

    <script>
        import { api, type Session } from "../lib/api";

        // Get icon HTML from templates
        const CALENDAR_ICON =
            document.getElementById("calendar-icon-template")?.innerHTML ?? "";
        const CLOCK_ICON =
            document.getElementById("clock-icon-template")?.innerHTML ?? "";

        let sessions: Session[] = [];
        let selectedSessions = new Map<number, number>(); // Turnus -> SessionId

        async function loadSessions() {
            try {
                const status = await api.getRegistrationStatus();

                if (!status) {
                    document.getElementById("sessions-container")!.innerHTML =
                        '<p class="bg-red-100 text-red-800 border-2 border-red-500 rounded-lg p-4 text-center font-bold">Prihlasovanie nie je momentálne otvorené.</p>';
                    return;
                }

                sessions = await api.getSessions();
                renderSessions();
            } catch (error) {
                console.error("Failed to load sessions:", error);
                document.getElementById("sessions-container")!.innerHTML =
                    '<p class="bg-red-100 text-red-800 border-2 border-red-500 rounded-lg p-4 text-center font-bold">Nepodarilo sa načítať termíny. Skúste obnoviť stránku.</p>';
            }
        }

        function renderSessions() {
            const container = document.getElementById("sessions-container")!;

            if (sessions.length === 0) {
                container.innerHTML =
                    '<p class="bg-blue-100 text-blue-800 border-2 border-blue-500 rounded-lg p-4 text-center font-bold">Momentálne nie sú k dispozícii žiadne termíny.</p>';
                return;
            }

            // Group sessions by turnus
            const turnus1 = sessions.filter((s) => s.turnus === 1);
            const turnus2 = sessions.filter((s) => s.turnus === 2);

            let html = "";

            if (turnus1.length > 0) {
                html += '<div class="mb-10">';
                html +=
                    '<h3 class="text-xl font-bold text-gray-900 mb-5 p-3 bg-gray-50 rounded-lg border-l-4 border-yellow-500">1. turnus (26.1.2026 - 30.1.2026)</h3>';
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">';
                html += renderSessionGroup(turnus1);
                html += "</div></div>";
            }

            if (turnus2.length > 0) {
                html += '<div class="mb-10">';
                html +=
                    '<h3 class="text-xl font-bold text-gray-900 mb-5 p-3 bg-gray-50 rounded-lg border-l-4 border-yellow-500">2. turnus (3.2.2026 - 9.2.2026)</h3>';
                html += '<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">';
                html += renderSessionGroup(turnus2);
                html += "</div></div>";
            }

            container.innerHTML = html;

            // Add event listeners to checkboxes
            document
                .querySelectorAll('input[type="checkbox"]')
                .forEach((checkbox) => {
                    checkbox.addEventListener("change", (e) => {
                        const target = e.target as HTMLInputElement;
                        const sessionId = parseInt(target.value);
                        const session = sessions.find(s => s.id === sessionId);

                        if (!session) return;

                        if (target.checked) {
                            // Uncheck other checkboxes in the same turnus
                            const turnusInputs = document.querySelectorAll(`input[name="session_turnus_${session.turnus}"]`);
                            turnusInputs.forEach((input: any) => {
                                if (input !== target && input.checked) {
                                    input.checked = false;
                                }
                            });

                            selectedSessions.set(session.turnus, sessionId);
                        } else {
                            // If unchecked, remove from selection
                            selectedSessions.delete(session.turnus);
                        }

                        const submitBtn = document.getElementById("submit-btn")!;
                        if (selectedSessions.size > 0) {
                            submitBtn.removeAttribute("disabled");
                        } else {
                            submitBtn.setAttribute("disabled", "true");
                        }
                    });
                });
        }

        function renderSessionGroup(sessions: Session[]): string {
            // Sort by date
            const sorted = [...sessions].sort(
                (a, b) =>
                    new Date(a.session_date).getTime() -
                    new Date(b.session_date).getTime(),
            );

            return sorted
                .map((session) => {
                    const isAvailable = session.available_spots > 0;
                    const dateObj = new Date(session.session_date);
                    const dayName = [
                        "Nedeľa",
                        "Pondelok",
                        "Utorok",
                        "Streda",
                        "Štvrtok",
                        "Piatok",
                        "Sobota",
                    ][dateObj.getDay()];
                    const dateFormatted = `${dateObj.getDate()}.${dateObj.getMonth() + 1}.${dateObj.getFullYear()}`;
                    const fullClass = !isAvailable
                        ? "opacity-60 bg-gray-50 border-gray-300 cursor-not-allowed"
                        : "bg-white border-gray-200 hover:border-yellow-500 hover:shadow-md hover:-translate-y-1 cursor-pointer";
                    const inputDisabled = !isAvailable ? "disabled" : "";
                    const inputName = `session_turnus_${session.turnus}`;

                    return `
                    <div class="border-2 rounded-xl transition-all duration-300 ${fullClass}">
                        <label class="flex items-center p-5 w-full h-full ${!isAvailable ? "cursor-not-allowed" : "cursor-pointer"}">
                            <input
                                type="checkbox"
                                name="${inputName}"
                                value="${session.id}"
                                ${inputDisabled}
                                class="w-5 h-5 mr-5 accent-yellow-500 cursor-pointer"
                            />
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center gap-3 mb-2">
                                    <span class="font-bold text-lg text-white bg-gradient-to-br from-yellow-500 to-yellow-600 px-3 py-1 rounded-md shadow-sm">${session.field_code}</span>
                                    <span class="font-bold text-gray-900 text-lg">${session.field_name}</span>
                                </div>
                                <div class="flex flex-wrap gap-5 text-gray-600 text-sm md:text-base mb-3">
                                    <span class="font-medium flex items-center gap-1">
                                        ${CALENDAR_ICON}
                                        ${dayName}, ${dateFormatted}
                                    </span>
                                    <span class="font-medium flex items-center gap-1">
                                        ${CLOCK_ICON}
                                        ${session.start_time} - ${session.end_time}
                                    </span>
                                </div>
                                <div class="font-bold text-sm px-2 py-1 rounded inline-block ${!isAvailable ? "text-red-600 bg-red-100" : "text-green-600 bg-green-100"}">
                                    ${
                                        isAvailable
                                            ? `Voľné miesta: ${session.available_spots}/${session.max_capacity}`
                                            : "PLNÉ"
                                    }
                                </div>
                            </div>
                        </label>
                    </div>
                `;
                })
                .join("");
        }

        async function handleSubmit(e: Event) {
            e.preventDefault();

            if (selectedSessions.size === 0) {
                showMessage("Prosím vyberte aspoň jeden termín", "error");
                return;
            }

            const form = e.target as HTMLFormElement;
            const formData = new FormData(form);

            const submitBtn = document.getElementById(
                "submit-btn",
            ) as HTMLButtonElement;
            submitBtn.disabled = true;
            submitBtn.textContent = "Prihlasovanie...";

            try {
                // Collect promises for all selected sessions
                const promises = [];
                const sessionsToRegister = [];

                for (const sessionId of selectedSessions.values()) {
                    sessionsToRegister.push(sessionId);
                }

                for (const sessionId of sessionsToRegister) {
                   promises.push(api.createRegistration({
                        session_id: sessionId,
                        student_first_name: formData.get(
                            "student_first_name",
                        ) as string,
                        student_last_name: formData.get(
                            "student_last_name",
                        ) as string,
                        guardian_first_name: formData.get(
                            "guardian_first_name",
                        ) as string,
                        guardian_last_name: formData.get(
                            "guardian_last_name",
                        ) as string,
                        guardian_phone: formData.get("guardian_phone") as string,
                        guardian_email: formData.get("guardian_email") as string,
                    }));
                }

                await Promise.all(promises);

                // Prepare details for success page
                const selectedSessionsDetails = sessionsToRegister
                    .map(id => sessions.find(s => s.id === id))
                    .filter(s => s !== undefined)
                    .map(s => ({
                        fieldCode: s!.field_code,
                        fieldName: s!.field_name,
                        date: s!.session_date,
                        startTime: s!.start_time,
                        endTime: s!.end_time,
                        turnus: s!.turnus
                    }));

                // Store registration details for success page
                if (selectedSessionsDetails.length > 0) {
                    const registrationDetails = {
                        student: {
                            firstName: formData.get(
                                "student_first_name",
                            ) as string,
                            lastName: formData.get(
                                "student_last_name",
                            ) as string,
                        },
                        sessions: selectedSessionsDetails
                    };
                    localStorage.setItem(
                        "lastRegistration",
                        JSON.stringify(registrationDetails),
                    );
                }

                // Redirect to success page
                window.location.href = "/success";
            } catch (error: any) {
                showMessage(
                    error.message ||
                        "Prihlásenie zlyhalo. Skúste to prosím znova.",
                    "error",
                );
                submitBtn.disabled = false;
                submitBtn.textContent = "Prihlásiť sa";
            }
        }

        function showMessage(
            message: string,
            type: "success" | "error" | "info",
        ) {
            const msgEl = document.getElementById("status-message")!;
            const baseClasses =
                "p-5 rounded-xl mb-8 text-center font-bold shadow-sm border-2";

            const typeClasses: Record<string, string> = {
                success: "bg-green-100 text-green-800 border-green-500",
                error: "bg-red-100 text-red-800 border-red-500",
                info: "bg-blue-100 text-blue-800 border-blue-500",
            };

            msgEl.className = `${baseClasses} ${typeClasses[type]}`;
            msgEl.textContent = message;
            msgEl.classList.remove("hidden");

            if (type === "success") {
                setTimeout(() => {
                    msgEl.classList.add("hidden");
                }, 5000);
            }
        }

        // Initialize
        document.addEventListener("DOMContentLoaded", () => {
            loadSessions();
            document
                .getElementById("registration-form")!
                .addEventListener("submit", handleSubmit);
        });
    </script>
</Layout>
