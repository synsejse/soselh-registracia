---
import Layout from "../../layouts/Layout.astro";
import Calendar from "../../icons/Calendar.astro";
import Clock from "../../icons/Clock.astro";
import Logo from "../../icons/Logo.astro";
import Check from "../../icons/Check.astro";
import Trash from "../../icons/Trash.astro";
---

<Layout title="Admin - Správa prihlásení">
    <main
        class="min-h-screen w-full bg-gradient-to-br from-gray-100 to-gray-300 py-8 px-4 sm:px-6 lg:px-8 flex justify-center items-start"
    >
        <div class="max-w-[1600px] w-full flex flex-col">
            <div
                class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 p-6 sm:p-8 bg-white rounded-2xl shadow-sm border border-gray-200"
            >
                <div class="flex flex-col md:flex-row items-center gap-5">
                    <Logo
                        class="h-16 w-auto"
                        aria-label="Logo SOŠ Elektrotechnická"
                    />
                    <h1
                        class="text-2xl sm:text-3xl md:text-4xl font-bold bg-gradient-to-br from-[#667eea] to-[#764ba2] text-transparent bg-clip-text text-center md:text-left"
                    >
                        Správa prihlásení na odborové dni
                    </h1>
                </div>
                <button
                    id="logout-btn"
                    class="w-full md:w-auto px-6 py-3 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl font-bold uppercase tracking-wider shadow-lg shadow-red-500/30 hover:shadow-red-500/40 hover:-translate-y-1 hover:from-red-600 hover:to-red-700 transition-all duration-300"
                    >Odhlásiť sa</button
                >
            </div>

            <div
                class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-10 mb-10"
            >
                <h2
                    class="text-2xl sm:text-3xl font-bold text-gray-900 mb-8 pb-4 border-b-4 border-yellow-500 inline-block"
                >
                    Akcie
                </h2>
                <div
                    class="flex flex-col lg:flex-row gap-6 justify-center items-center"
                >
                    <button
                        id="toggle-btn"
                        class="w-full lg:w-auto min-w-[300px] px-8 py-4 rounded-xl font-bold text-lg uppercase tracking-wider shadow-lg transition-all duration-300 hover:-translate-y-1 text-white disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none text-center"
                    >
                        <span id="toggle-text">Načítavam...</span>
                    </button>

                    <button
                        id="refresh-btn"
                        class="w-full lg:w-auto px-8 py-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl font-bold uppercase tracking-wider shadow-lg shadow-blue-500/30 hover:shadow-blue-500/40 hover:-translate-y-1 hover:from-blue-600 hover:to-blue-700 transition-all duration-300"
                        >Obnoviť zoznam</button
                    >
                    <button
                        id="export-btn"
                        class="w-full lg:w-auto px-8 py-4 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl font-bold uppercase tracking-wider shadow-lg shadow-green-500/30 hover:shadow-green-500/40 hover:-translate-y-1 hover:from-green-600 hover:to-green-700 transition-all duration-300"
                        >Export do Excelu</button
                    >
                </div>
            </div>

            <div
                id="status-message"
                class="hidden p-5 rounded-xl mb-8 text-center font-bold text-lg shadow-sm border-2"
            >
            </div>

            <div
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-10"
                id="stats-container"
            >
                <div
                    class="bg-white rounded-2xl p-8 text-center border border-gray-200 shadow-sm relative overflow-hidden group hover:-translate-y-1 hover:shadow-md transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-full before:h-1 before:bg-gradient-to-r before:from-yellow-500 before:to-yellow-400"
                >
                    <div
                        class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-br from-yellow-500 to-yellow-400 mb-3"
                        id="total-registrations"
                    >
                        0
                    </div>
                    <div
                        class="text-gray-600 font-semibold uppercase tracking-wider text-sm"
                    >
                        Celkový počet prihlásení
                    </div>
                </div>
                <div
                    class="bg-white rounded-2xl p-8 text-center border border-gray-200 shadow-sm relative overflow-hidden group hover:-translate-y-1 hover:shadow-md transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-full before:h-1 before:bg-gradient-to-r before:from-yellow-500 before:to-yellow-400"
                >
                    <div
                        class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-br from-yellow-500 to-yellow-400 mb-3"
                        id="turnus1-count"
                    >
                        0
                    </div>
                    <div
                        class="text-gray-600 font-semibold uppercase tracking-wider text-sm"
                    >
                        1. turnus
                    </div>
                </div>
                <div
                    class="bg-white rounded-2xl p-8 text-center border border-gray-200 shadow-sm relative overflow-hidden group hover:-translate-y-1 hover:shadow-md transition-all duration-300 before:absolute before:top-0 before:left-0 before:w-full before:h-1 before:bg-gradient-to-r before:from-yellow-500 before:to-yellow-400"
                >
                    <div
                        class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-br from-yellow-500 to-yellow-400 mb-3"
                        id="turnus2-count"
                    >
                        0
                    </div>
                    <div
                        class="text-gray-600 font-semibold uppercase tracking-wider text-sm"
                    >
                        2. turnus
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 sm:p-10 mb-10"
            >
                <h2
                    class="text-2xl sm:text-3xl font-bold text-gray-900 mb-8 pb-4 border-b-4 border-yellow-500 inline-block"
                >
                    Všetky prihlásenia
                </h2>

                <div
                    class="flex flex-col md:flex-row gap-6 mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200"
                >
                    <label
                        class="flex flex-col gap-3 font-semibold text-gray-700 w-full md:w-auto"
                    >
                        Filtrovať podľa odboru:
                        <select
                            id="field-filter"
                            class="px-4 py-3 border-2 border-gray-300 rounded-lg text-base min-w-[280px] bg-white focus:outline-none focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/10 hover:border-yellow-500 transition-colors"
                        >
                            <option value="">Všetky odbory</option>
                            <option value="ELE">ELE - Elektrotechnika</option>
                            <option value="IST"
                                >IST - Informačné a sieťové technológie</option
                            >
                            <option value="MUM">MUM - Multimédia</option>
                            <option value="MPS"
                                >MPS - Mechanik počítačových sietí</option
                            >
                        </select>
                    </label>
                    <label
                        class="flex flex-col gap-3 font-semibold text-gray-700 w-full md:w-auto"
                    >
                        Filtrovať podľa turnusu:
                        <select
                            id="turnus-filter"
                            class="px-4 py-3 border-2 border-gray-300 rounded-lg text-base min-w-[280px] bg-white focus:outline-none focus:border-yellow-500 focus:ring-4 focus:ring-yellow-500/10 hover:border-yellow-500 transition-colors"
                        >
                            <option value="">Všetky turnusy</option>
                            <option value="1">1. turnus</option>
                            <option value="2">2. turnus</option>
                        </select>
                    </label>
                </div>

                <div id="registrations-list" class="mt-6 overflow-x-auto">
                    <p
                        class="text-center text-gray-500 p-6 text-lg font-medium"
                    >
                        Načítavam prihlásenia...
                    </p>
                </div>
            </div>

            <div
                class="mt-auto pt-10 text-center text-gray-500 font-semibold text-sm"
            >
                <span>Kristián Kekeš & SOŠ Elektrotechnická</span>
            </div>
        </div>

        <!-- Export Modal -->
        <div
            id="export-modal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
        >
            <!-- Backdrop -->
            <div
                id="export-backdrop"
                class="absolute inset-0 bg-black/50 backdrop-blur-sm"
            >
            </div>
            <!-- Modal Content -->
            <div
                class="relative bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full border border-gray-200 animate-[slideUp_0.3s_ease-out]"
            >
                <h3 class="text-2xl font-bold text-gray-900 mb-6 text-center">
                    Exportovať do Excelu
                </h3>

                <div class="mb-8">
                    <!-- Replaced plain checkbox with fancy-checkbox design copied from index.astro -->
                    <label
                        class="flex items-start gap-4 cursor-pointer group p-4 border-2 border-gray-200 rounded-xl hover:border-yellow-500 transition-colors"
                    >
                        <div class="fancy-checkbox mt-0.5 shrink-0">
                            <input
                                type="checkbox"
                                id="export-include-unconfirmed"
                            />
                            <div
                                class="box w-[22px] h-[22px] flex items-center justify-center rounded-md border border-gray-300 bg-white transition-all duration-200"
                            >
                                <Check class="w-4 h-4 text-white" />
                            </div>
                        </div>
                        <span class="text-gray-700 font-medium select-none"
                            >Zahrnúť aj nepotvrdené (červené) registrácie</span
                        >
                    </label>

                    <p class="mt-2 text-sm text-gray-500 px-1">
                        V predvolenom nastavení sa exportujú iba potvrdené
                        registrácie.
                    </p>
                </div>

                <div class="flex gap-4 justify-center">
                    <button
                        id="export-cancel"
                        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-xl font-bold uppercase tracking-wider hover:bg-gray-300 transition-all duration-300"
                    >
                        Zrušiť
                    </button>
                    <button
                        id="export-confirm"
                        class="px-6 py-3 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl font-bold uppercase tracking-wider shadow-lg hover:from-green-600 hover:to-green-700 hover:-translate-y-1 transition-all duration-300"
                    >
                        Stiahnuť
                    </button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div
            id="confirm-modal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
        >
            <!-- Backdrop -->
            <div
                id="modal-backdrop"
                class="absolute inset-0 bg-black/50 backdrop-blur-sm"
            >
            </div>
            <!-- Modal Content -->
            <div
                class="relative bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full border border-gray-200 animate-[slideUp_0.3s_ease-out]"
            >
                <h3
                    class="text-2xl font-bold text-gray-900 mb-4 text-center"
                    id="modal-title"
                >
                    Potvrdiť zmenu
                </h3>
                <p
                    class="text-gray-600 text-center mb-8 text-lg"
                    id="modal-message"
                >
                </p>
                <div class="flex gap-4 justify-center">
                    <button
                        id="modal-cancel"
                        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-xl font-bold uppercase tracking-wider hover:bg-gray-300 transition-all duration-300"
                    >
                        Zrušiť
                    </button>
                    <button
                        id="modal-confirm"
                        class="px-6 py-3 bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-xl font-bold uppercase tracking-wider shadow-lg hover:from-yellow-600 hover:to-yellow-700 hover:-translate-y-1 transition-all duration-300"
                    >
                        Potvrdiť
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden icon templates for JavaScript to reference -->
        <template id="calendar-icon-template">
            <Calendar class="h-5 w-5" />
        </template>
        <template id="clock-icon-template">
            <Clock class="h-5 w-5" />
        </template>
        <template id="check-icon-template">
            <Check class="h-5 w-5" />
        </template>
        <template id="trash-icon-template">
            <Trash class="h-5 w-5" />
        </template>
    </main>

    <script>
        import { api, type RegistrationResponse } from "../../lib/api";

        // Get icon HTML from templates
        const CALENDAR_ICON =
            document.getElementById("calendar-icon-template")?.innerHTML ?? "";
        const CLOCK_ICON =
            document.getElementById("clock-icon-template")?.innerHTML ?? "";
        const CHECK_ICON =
            document.getElementById("check-icon-template")?.innerHTML ?? "";
        const TRASH_ICON =
            document.getElementById("trash-icon-template")?.innerHTML ?? "";

        let allRegistrations: RegistrationResponse[] = [];
        let registrationEnabled = false;

        // Check authentication
        async function checkAuth() {
            try {
                const isAuth = await api.admin.checkAuth();
                if (!isAuth) {
                    window.location.href = "/admin/login";
                }
            } catch (error) {
                window.location.href = "/admin/login";
            }
        }

        async function loadRegistrationStatus() {
            try {
                registrationEnabled = await api.getRegistrationStatus();
                updateToggleButton();
            } catch (error) {
                console.error("Error loading status:", error);
            }
        }

        async function loadRegistrations() {
            try {
                allRegistrations = await api.admin.getRegistrations();
                updateStats();
                renderRegistrations();
            } catch (error: any) {
                console.error("Error loading registrations:", error);
                showMessage(
                    error.message || "Chyba pri načítaní prihlásení",
                    "error",
                );
            }
        }

        function updateStats() {
            const total = allRegistrations.length;
            const turnus1 = allRegistrations.filter(
                (r) => r.session.turnus === 1,
            ).length;
            const turnus2 = allRegistrations.filter(
                (r) => r.session.turnus === 2,
            ).length;

            document.getElementById("total-registrations")!.textContent =
                total.toString();
            document.getElementById("turnus1-count")!.textContent =
                turnus1.toString();
            document.getElementById("turnus2-count")!.textContent =
                turnus2.toString();
        }

        function renderRegistrations() {
            const fieldFilter = (
                document.getElementById("field-filter") as HTMLSelectElement
            ).value;
            const turnusFilter = (
                document.getElementById("turnus-filter") as HTMLSelectElement
            ).value;

            let filtered = allRegistrations;

            if (fieldFilter) {
                filtered = filtered.filter(
                    (r) => r.session.field_code === fieldFilter,
                );
            }

            if (turnusFilter) {
                filtered = filtered.filter(
                    (r) => r.session.turnus === parseInt(turnusFilter),
                );
            }

            const container = document.getElementById("registrations-list")!;

            if (filtered.length === 0) {
                container.innerHTML =
                    '<p class="p-6 text-center text-blue-800 bg-blue-100 border-2 border-blue-500 rounded-lg font-bold">Nenašli sa žiadne prihlásenia podľa zvoleného filtra.</p>';
                return;
            }

            // Sort by session date and time
            const sorted = filtered.sort((a, b) => {
                const dateA = new Date(
                    a.session.session_date + " " + a.session.start_time,
                );
                const dateB = new Date(
                    b.session.session_date + " " + b.session.start_time,
                );
                return dateA.getTime() - dateB.getTime();
            });

            // Group by session
            const groupedBySession: Record<number, RegistrationResponse[]> = {};

            sorted.forEach((reg) => {
                if (!groupedBySession[reg.session.id]) {
                    groupedBySession[reg.session.id] = [];
                }
                groupedBySession[reg.session.id].push(reg);
            });

            let html = "";

            for (const sessionId in groupedBySession) {
                const regs = groupedBySession[sessionId];
                const session = regs[0].session;
                const dateObj = new Date(session.session_date);
                const dayName = [
                    "Nedeľa",
                    "Pondelok",
                    "Utorok",
                    "Streda",
                    "Štvrtok",
                    "Piatok",
                    "Sobota",
                ][dateObj.getDay()];
                const dateFormatted = `${dayName}, ${session.session_date}`;

                html += `
                <div class="mb-10 bg-white border-2 border-yellow-500 rounded-xl overflow-hidden shadow-lg shadow-yellow-500/10">
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 sm:p-8 border-b-2 border-yellow-500">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 flex flex-wrap items-center gap-4">
                            <span class="font-extrabold text-white bg-gradient-to-br from-yellow-500 to-yellow-600 px-4 py-1 rounded-lg text-lg shadow-sm tracking-wide">${session.field_code}</span>
                            ${session.field_name}
                        </h3>
                        <div class="flex flex-wrap gap-4 sm:gap-6 text-gray-600 font-medium text-base">
                            <span class="bg-blue-50 text-blue-700 px-4 py-1 rounded-md border border-blue-200 font-bold">${session.turnus}. turnus</span>
                            <span class="flex items-center gap-1">${CALENDAR_ICON}${dateFormatted}</span>
                            <span class="flex items-center gap-1">${CLOCK_ICON}${session.start_time} - ${session.end_time}</span>
                            <span class="bg-green-50 text-green-700 px-4 py-1 rounded-md border border-green-200 font-bold">${regs.length} prihlásení</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 border-r border-r-gray-700 text-sm uppercase tracking-wider whitespace-nowrap first:rounded-tl-none">ID</th>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 border-r border-r-gray-700 text-sm uppercase tracking-wider whitespace-nowrap">Žiak</th>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 border-r border-r-gray-700 text-sm uppercase tracking-wider whitespace-nowrap">Zástupca</th>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 border-r border-r-gray-700 text-sm uppercase tracking-wider whitespace-nowrap">Kontakt</th>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 border-r border-r-gray-700 text-sm uppercase tracking-wider whitespace-nowrap">Dátum prihlásenia</th>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 border-r border-r-gray-700 text-sm uppercase tracking-wider whitespace-nowrap">Stav</th>
                                    <th class="bg-gradient-to-br from-gray-800 to-gray-900 p-4 sm:p-5 text-left font-bold text-white border-b-2 border-gray-600 text-sm uppercase tracking-wider whitespace-nowrap last:rounded-tr-none">Akcie</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${regs
                                    .map(
                                        (reg, index) => `
                                    <tr class="${index % 2 === 0 ? "bg-white" : "bg-gray-50"} hover:bg-yellow-50 transition-colors duration-200">
                                        <td class="p-4 border-b border-r border-gray-200 text-gray-800 font-medium">${reg.id}</td>
                                        <td class="p-4 border-b border-r border-gray-200 text-gray-800 font-medium">
                                            <div class="font-bold">${reg.student_first_name} ${reg.student_last_name}</div>
                                        </td>
                                        <td class="p-4 border-b border-r border-gray-200 text-gray-600">
                                            <div class="font-medium text-gray-900">${reg.guardian_first_name} ${reg.guardian_last_name}</div>
                                        </td>
                                        <td class="p-4 border-b border-r border-gray-200 text-gray-600 font-mono text-sm">
                                            <div>${reg.guardian_email}</div>
                                            <div class="text-xs text-gray-500 mt-1">${reg.guardian_phone}</div>
                                        </td>
                                        <td class="p-4 border-b border-r border-gray-200 text-gray-600 text-sm">${formatDateTime(reg.created_at)}</td>
                                        <td class="p-4 border-b border-r border-gray-200 font-bold ${reg.confirmed ? "text-green-600" : "text-red-500"}">
                                            ${reg.confirmed ? "Potvrdené" : "Čaká na potvrdenie"}
                                        </td>
                                        <td class="p-4 border-b border-gray-200 text-gray-600 text-sm">
                                            <div class="flex gap-2 justify-center">
                                                ${
                                                    !reg.confirmed
                                                        ? `<button class="btn-confirm bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg shadow-sm transition-colors" title="Potvrdiť" data-id="${reg.id}">${CHECK_ICON}</button>`
                                                        : ""
                                                }
                                                <button class="btn-delete bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg shadow-sm transition-colors" title="Zmazať" data-id="${reg.id}">${TRASH_ICON}</button>
                                            </div>
                                        </td>
                                    </tr>
                                `,
                                    )
                                    .join("")}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }

            container.innerHTML = html;

            // Add listeners
            document.querySelectorAll(".btn-confirm").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    // Use currentTarget to ensure we get the button element, not the inner SVG
                    const target = e.currentTarget as HTMLElement;
                    const id = parseInt(target.getAttribute("data-id") || "0");
                    if (id) await handleConfirmRegistration(id);
                });
            });

            document.querySelectorAll(".btn-delete").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    // Use currentTarget to ensure we get the button element, not the inner SVG
                    const target = e.currentTarget as HTMLElement;
                    const id = parseInt(target.getAttribute("data-id") || "0");
                    if (id) await handleDeleteRegistration(id);
                });
            });
        }

        async function handleConfirmRegistration(id: number) {
            try {
                await api.admin.confirmRegistration(id);
                showMessage("Registrácia bola potvrdená", "success");
                loadRegistrations();
            } catch (error: any) {
                console.error("Error confirming registration:", error);
                showMessage(error.message || "Chyba pri potvrdzovaní", "error");
            }
        }

        async function handleDeleteRegistration(id: number) {
            const confirmed = await showConfirmModal(
                "Zmazať registráciu",
                "Naozaj chcete zmazať túto registráciu? Táto akcia je nevratná.",
            );
            if (!confirmed) return;

            try {
                await api.admin.deleteRegistration(id);
                showMessage("Registrácia bola zmazaná", "success");
                loadRegistrations();
            } catch (error: any) {
                console.error("Error deleting registration:", error);
                showMessage(error.message || "Chyba pri mazaní", "error");
            }
        }

        function formatDateTime(dateTimeStr: string): string {
            // Format: YYYY-MM-DD HH:MM:SS
            const date = new Date(dateTimeStr);
            const day = String(date.getDate()).padStart(2, "0");
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function showConfirmModal(
            title: string,
            message: string,
        ): Promise<boolean> {
            return new Promise((resolve) => {
                const modal = document.getElementById("confirm-modal")!;
                const modalTitle = document.getElementById("modal-title")!;
                const modalMessage = document.getElementById("modal-message")!;
                const confirmBtn = document.getElementById("modal-confirm")!;
                const cancelBtn = document.getElementById("modal-cancel")!;
                const backdrop = document.getElementById("modal-backdrop")!;

                modalTitle.textContent = title;
                modalMessage.textContent = message;

                modal.classList.remove("hidden");

                const cleanup = () => {
                    modal.classList.add("hidden");
                    confirmBtn.removeEventListener("click", handleConfirm);
                    cancelBtn.removeEventListener("click", handleCancel);
                    backdrop.removeEventListener("click", handleCancel);
                };

                const handleConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                confirmBtn.addEventListener("click", handleConfirm);
                cancelBtn.addEventListener("click", handleCancel);
                backdrop.addEventListener("click", handleCancel);
            });
        }

        async function toggleRegistration() {
            const newState = !registrationEnabled;
            const message = newState
                ? "Naozaj chcete ZAPNÚŤ prihlasovanie? Používatelia sa budú môcť prihlasovať na odborové dni."
                : "Naozaj chcete VYPNÚŤ prihlasovanie? Používatelia sa nebudú môcť prihlasovať na odborové dni.";

            const confirmed = await showConfirmModal("Potvrdiť zmenu", message);
            if (!confirmed) return;

            const btn = document.getElementById(
                "toggle-btn",
            ) as HTMLButtonElement;
            btn.disabled = true;

            try {
                await api.admin.toggleRegistration();
                const newStatus = !registrationEnabled;
                registrationEnabled = newStatus;
                updateToggleButton();
                showMessage(
                    `Prihlasovanie bolo ${newStatus ? "zapnuté" : "vypnuté"}`,
                    "success",
                );
            } catch (error: any) {
                showMessage(error.message || "Chyba pri zmene stavu", "error");
            } finally {
                btn.disabled = false;
            }
        }

        function updateToggleButton() {
            const btn = document.getElementById("toggle-btn")!;
            const text = document.getElementById("toggle-text")!;

            if (registrationEnabled) {
                text.textContent = "Prihlasovanie je ZAPNUTÉ";
                btn.className =
                    "w-full md:w-auto md:min-w-[400px] px-8 py-4 rounded-xl font-bold text-lg uppercase tracking-wider shadow-lg transition-all duration-300 hover:-translate-y-1 text-white bg-gradient-to-br from-green-500 to-green-600 shadow-green-500/30 hover:shadow-green-500/40 hover:from-green-600 hover:to-green-700";
            } else {
                text.textContent = "Prihlasovanie je VYPNUTÉ";
                btn.className =
                    "w-full md:w-auto md:min-w-[400px] px-8 py-4 rounded-xl font-bold text-lg uppercase tracking-wider shadow-lg transition-all duration-300 hover:-translate-y-1 text-white bg-gradient-to-br from-red-500 to-red-600 shadow-red-500/30 hover:shadow-red-500/40 hover:from-red-600 hover:to-red-700";
            }
        }

        function showMessage(
            message: string,
            type: "success" | "error" | "info",
        ) {
            const msgEl = document.getElementById("status-message")!;
            const baseClasses =
                "p-5 rounded-xl mb-8 text-center font-bold text-lg shadow-sm border-2";

            const typeClasses: Record<string, string> = {
                success: "bg-green-100 text-green-800 border-green-500",
                error: "bg-red-100 text-red-800 border-red-500",
                info: "bg-blue-100 text-blue-800 border-blue-500",
            };

            msgEl.className = `${baseClasses} ${typeClasses[type]}`;
            msgEl.textContent = message;
            msgEl.classList.remove("hidden");

            setTimeout(() => {
                msgEl.classList.add("hidden");
            }, 5000);
        }

        // Logout handler
        async function handleLogout() {
            try {
                await api.admin.logout();
                window.location.href = "/admin/login";
            } catch (error) {
                console.error("Error during logout:", error);
                window.location.href = "/admin/login";
            }
        }

        async function handleExport() {
            const includeUnconfirmed = await showExportModal();
            if (includeUnconfirmed === null) return; // User cancelled

            const queryParams = includeUnconfirmed
                ? "?include_unconfirmed=true"
                : "";

            try {
                const response = await fetch(
                    `/api/admin/registrations/export${queryParams}`,
                );
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "registracie.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showMessage("Export bol úspešný", "success");
                } else {
                    showMessage("Chyba pri exporte", "error");
                }
            } catch (error) {
                console.error("Error exporting:", error);
                showMessage("Chyba pri exporte", "error");
            }
        }

        function showExportModal(): Promise<boolean | null> {
            return new Promise((resolve) => {
                const modal = document.getElementById("export-modal")!;
                const confirmBtn = document.getElementById("export-confirm")!;
                const cancelBtn = document.getElementById("export-cancel")!;
                const backdrop = document.getElementById("export-backdrop")!;
                const checkbox = document.getElementById(
                    "export-include-unconfirmed",
                ) as HTMLInputElement;

                // Reset checkbox
                checkbox.checked = false;

                modal.classList.remove("hidden");

                const cleanup = () => {
                    modal.classList.add("hidden");
                    confirmBtn.removeEventListener("click", handleConfirm);
                    cancelBtn.removeEventListener("click", handleCancel);
                    backdrop.removeEventListener("click", handleCancel);
                };

                const handleConfirm = () => {
                    cleanup();
                    resolve(checkbox.checked);
                };

                const handleCancel = () => {
                    cleanup();
                    resolve(null);
                };

                confirmBtn.addEventListener("click", handleConfirm);
                cancelBtn.addEventListener("click", handleCancel);
                backdrop.addEventListener("click", handleCancel);
            });
        }

        // Initialize
        document.addEventListener("DOMContentLoaded", async () => {
            await checkAuth();
            loadRegistrationStatus();
            loadRegistrations();

            document
                .getElementById("toggle-btn")!
                .addEventListener("click", toggleRegistration);
            document
                .getElementById("refresh-btn")!
                .addEventListener("click", () => {
                    loadRegistrations();
                    showMessage("Zoznam bol obnovený", "info");
                });
            document
                .getElementById("logout-btn")!
                .addEventListener("click", handleLogout);

            document
                .getElementById("export-btn")!
                .addEventListener("click", handleExport);

            document
                .getElementById("field-filter")!
                .addEventListener("change", renderRegistrations);
            document
                .getElementById("turnus-filter")!
                .addEventListener("change", renderRegistrations);
        });
    </script>
</Layout>

<style>
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Make styles global for JS-injected HTML - copied from index.astro */
    :global(.fancy-checkbox) {
        position: relative;
        width: 22px;
        height: 22px;
    }

    :global(.fancy-checkbox input) {
        appearance: none;
        position: absolute;
        inset: 0;
        cursor: pointer;
    }

    :global(.fancy-checkbox svg) {
        transform: scale(0);
        transition: transform 0.2s ease;
    }

    :global(.fancy-checkbox input:checked + .box) {
        background: #eab308; /* yellow-500 */
        border-color: #eab308;
        animation: checkbox-pulse 0.35s ease;
    }

    :global(.fancy-checkbox input:checked + .box svg) {
        transform: scale(1);
    }

    :global(.fancy-checkbox input:focus-visible + .box) {
        box-shadow: 0 0 0 4px rgba(234, 179, 8, 0.25);
    }

    :global(.fancy-checkbox input:disabled + .box) {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Card highlight (not strictly needed here but kept for parity) */
    :global(.session-card.checked) {
        border-color: #eab308 !important;
        box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.25);
        transform: translateY(-2px);
    }

    @keyframes checkbox-pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.25);
        }
        100% {
            transform: scale(1);
        }
    }
</style>
